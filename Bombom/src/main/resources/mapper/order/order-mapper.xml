<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="order">
	<resultMap type="order" id="orderMap">
		<result property="orderNo" column="order_no" />
		<result property="memNo" column="mem_no" />
		<result property="ordAmount" column="ord_amount" />
		<result property="ordUsePoint" column="ord_use_point" />
		<result property="ordZipcode" column="ord_zipcode" />
		<result property="ordAddr" column="ord_addr" />
		<result property="ordDetailAddr" column="ord_detail_addr" />
		<result property="ordExtraAddr" column="ord_extra_addr" />
		<result property="ordTrack" column="ord_track" />
		<result property="ordMemo" column="ord_memo" />
		<result property="ordDeliPrice" column="ord_deli_price" />
		<result property="ordConfirmYn" column="ord_confirm_yn" />
		<result property="ordStatus" column="ord_status" />
		<result property="ordCancel" column="ord_cancel" />
		<result property="ordDate" column="ord_date" />
		<result property="ordOname" column="ord_oname" />
		<result property="ordOphone" column="ord_ophone" />
		<result property="ordRname" column="ord_rname" />
		<result property="ordRphone" column="ord_rphone" />
		<result property="ordRemail" column="pdt_option_addprice" />
		
		<result property="pdtThumbImage" column="thumbs" />
		<result property="pdtName" column="pdt_name" />
		<result property="pdtOptionContent" column="pdt_option_content" />
		<result property="inorderQty" column="inorder_qty" />
		<result property="pdtPrice" column="pdt_price" />
		<result property="memEmail" column="mem_email" />
		<result property="pdtOptionAddprice" column="pdt_option_addprice" />
	</resultMap>
	<resultMap type="inorder" id="inorderMap">
		<result property="orderNo" column="order_no" />
		<result property="pdtNo" column="pdt_no" />
		<result property="pdtOptionNo" column="pdt_option_no" />
		<result property="inorderQty" column="inorder_qty" />
	</resultMap>
	<resultMap type="basket" id="basketMap">
		<result property="basketNo" column="basket_no" />
		<result property="memNo" column="mem_no" />
		<result property="pdtNo" column="pdt_no" />
		<result property="pdtOptionNo" column="pdt_option_no" />
		<result property="inbasQty" column="inbas_qty" />
		<result property="pdtName" column="pdt_name" />
		<result property="pdtThumbImage" column="thumbs" />
		<result property="pdtOptionContent" column="pdt_option_content" />
		<result property="pdtPrice" column="pdt_price" />
		<result property="pdtOptionAddprice"
			column="pdt_option_addprice" />
		<result property="salePer" column="event_sale_per" />
	</resultMap>
	<resultMap type="inbasket" id="inbasketMap">
		<result property="pdtNo" column="pdt_no" />
		<result property="basketNo" column="pdt_no" />
		<result property="pdtOptionNo" column="pdt_option_no" />
		<result property="inbasQty" column="inbas_qty" />
	</resultMap>

	<insert id="insertOrder" parameterType="order">
		INSERT INTO "ORDER"
		VALUES (#{orderNo}, #{memNo},#{ordAmount},
		#{ordUsePoint}, #{ordZipcode}, #{ordAddr},
		#{ordDetailAddr},#{ordExtraAddr},
		#{ordDeliPrice},#{ordConfirmYn},
		#{ordStatus},#{ordCancel},
		SYSDATE,#{ordOname},<!-- sysdate => ordDate -->
		#{ordOpone},#{ordRname}, #{ordRphone})
	</insert>


	<select id="selectBasket" parameterType="string" resultMap="basketMap">
		SELECT DISTINCT
			P.PDT_PRICE,P.PDT_NO,
			P.PDT_NAME,OP.PDT_OPTION_CONTENT,OP.PDT_OPTION_NO,
			OP.PDT_OPTION_ADDPRICE, I.INBAS_QTY, B.MEM_NO,B.BASKET_NO,
			E.EVENT_SALE_PER,
			LISTAGG(PDT_THUMB_IMAGE,',') 
			WITHIN GROUP(ORDER BY TH.pdt_no_ref)
			OVER(PARTITION BY TH.PDT_NO_REF)AS THUMBS
		FROM BASKET B
			LEFT JOIN MEMBER M ON (M.MEM_NO=B.MEM_NO)
			LEFT JOIN INBASKET I ON
			(I.BASKET_NO=B.BASKET_NO)
			LEFT JOIN PRODUCT P ON (P.PDT_NO=I.PDT_NO)
			LEFT JOIN PRODUCT_OPTION OP ON (OP.PDT_OPTION_NO=I.PDT_OPTION_NO)
			LEFT JOIN PRODUCT_THUMB TH ON (TH.PDT_NO_REF=I.PDT_NO)
			LEFT JOIN EVENT E ON(P.EVENT_NO_REF=E.EVENT_NO)
		WHERE B.MEM_NO=#{memNo}
	</select>

	<delete id="deleteBasketPdt" parameterType="basket">
		DELETE FROM INBASKET
		WHERE BASKET_NO = #{basketNo} AND PDT_NO = #{pdtNo}
	</delete>
	
	<delete id="deleteBasketOption" parameterType="string">
		DELETE FROM
		INBASKET WHERE PDT_OPTION_NO = #{pdtOptionNo}
	</delete>


</mapper>